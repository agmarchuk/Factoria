@page
@using Factograph.Data
@using Factograph.Data.r
@model IndexModel
@{
    ViewData["Title"] = "Home page";
    IndexModel m = Model;
}

@if(m.search_results.Length > 0)
{
    <div>
        <p class="grad">
            <a href="/" class="nov"><img src="img/ico-home.gif" class="ico-home" alt="" />Открытый архив</a>
            &raquo;
            Результаты поиска
        </p>
        <ul class="links">
            @foreach (RRecord rr in m.search_results)
            {
                string nm = rr.GetName();
                string dt = rr.GetDates();
                string? descr = rr.GetField("http://fogid.net/o/description");
                <li>
                    <a href='?id=@(rr.Id)' ).Value'>@nm</a>
                    @if (!string.IsNullOrEmpty(dt))
                    {
                        <span>(@dt)</span>
                    }
                    @descr
                </li>
            }
        </ul>
    </div>
} else
{
    Rec? tree = @Model.tree;

    string? name = tree?.GetText("http://fogid.net/o/name");
    string? dates = tree?.GetDates();
    string? description = tree?.GetText("http://fogid.net/o/description");

    if (tree == null)
    {
        <div class="text-center">
            Это пустой портрет
        </div>
    }
    else if (tree.Tp == "http://fogid.net/o/person")
    {
        <p class="grad">
            <a href="" class="nov"><img src="img/ico-home.gif" class="ico-home" alt="" />Открытый архив</a>
            &raquo;
            Персоны
            &raquo;
            @name
        </p>
        <div class="heading1">
            <h1>
                @name
                @dates
            </h1>
        </div>
        <p>
            @tree.GetText("http://fogid.net/o/description")
        </p>
        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="info-person">
            @{
                // ===== Подготовка списков отношений ====
                var titles = tree.GetInverse("http://fogid.net/o/has-title");
                var works = tree.GetInverse("http://fogid.net/o/participant").Where(re =>
                {
                    var org = re.GetDirect("http://fogid.net/o/in-org");
                    string? org_classification = org?.GetStr("http://fogid.net/o/org-classification");
                    return string.IsNullOrEmpty(org_classification) || org_classification == "organization";
                });
                var notworks = tree.GetInverse("http://fogid.net/o/participant").Where(re =>
                {
                    var org = re.GetDirect("http://fogid.net/o/in-org");
                    string? org_classification = org?.GetStr("http://fogid.net/o/org-classification");
                    return !string.IsNullOrEmpty(org_classification) && org_classification != "organization";
                });
                // Проживание
                var livings = tree.GetInverse("http://fogid.net/o/something");

                // Авторство
                var auth = tree.GetInverse("http://fogid.net/o/author");

                // Документы, отражающие
                var refl_docs = tree.GetInverse("http://fogid.net/o/reflected");

                if (titles.Count() > 0)
                {
                    <tr valign="top">
                        <td width="25%" class="line-name">Титул:</td>
                        <td width="75%" class="line-info">
                            @foreach (var tit in titles.OrderBy(t => t.GetDates()))
                            {
                                string dts = tit.GetDates();
                                <span>@tit.GetText("http://fogid.net/o/degree")</span>
                                if (!string.IsNullOrEmpty(dts))
                                {
                                    <span>(@dts)</span>
                                }
                                <br />
                            }
                        </td>
                    </tr>
                }
                @if (works.Count() > 0)
                {
                    <tr valign="top">
                        <td width="25%" class="line-name">Место работы:</td>
                        <td width="75%" class="line-info">
                            @foreach (var work in works.OrderBy(w => w.GetStr("http://fogid.net/o/from-date")))
                            {
                                var org = work.GetDirect("http://fogid.net/o/in-org");
                                string? nm = org?.GetText("http://fogid.net/o/name");
                                string? dt = work?.GetDates();
                                if (org != null)
                                {
                                    <a href='?id=@org.Id'>@nm</a>
                                    if (!string.IsNullOrEmpty(dt))
                                    {
                                        <span>(@dt)</span>
                                    }
                                    <br />
                                }
                            }
                        </td>
                    </tr>
                }
                @if (notworks.Count() > 0)
                {
                    <tr valign="top">
                        <td width="25%" class="line-name">Участие в мероприятиях:</td>
                        <td width="75%" class="line-info">
                            @foreach (var part in notworks.OrderBy(w => w.GetStr("http://fogid.net/o/from-date")))
                            {
                                var org = part.GetDirect("http://fogid.net/o/in-org");
                                string? nm = org?.GetText("http://fogid.net/o/name");
                                string? dt = part?.GetDates();
                                if (org != null)
                                {
                                    <a href='?id=@org.Id'>@nm</a>
                                    if (!string.IsNullOrEmpty(dt))
                                    {
                                        <span>(@dt)</span>
                                    }
                                    <br />
                                }
                            }
                        </td>
                    </tr>
                }
                @if (@livings.Count() > 0)
                {
                    <tr valign="top">
                        <td width="25%" class="line-name">Геоинформация:</td>
                        <td width="75%" class="line-info">
                            @foreach (var live in livings)
                            {
                                var geo = live.GetDirect("http://fogid.net/o/location-place");
                                string? nm = geo?.GetText("http://fogid.net/o/name");
                                string? dt = live?.GetDates();
                                string? lc = live?.SayStr("http://fogid.net/o/location-classification");
                                if (geo != null)
                                {
                                    <a href='?id=@geo.Id'>@nm</a>
                                    <span>@lc</span>
                                    if (!string.IsNullOrEmpty(dt))
                                    {
                                        <span>(@dt)</span>
                                    }
                                    <br />
                                }

                            }
                        </td>
                    </tr>
                }

            }
        </table>
        <br />
        <br />
        @if (auth.Count() > 0)
        {
            <div class="heading3">
                <h3>Является автором/получателем документов</h3>
            </div>

            <table cellpadding="0" cellspacing="0" border="0" width="100%" class="info-docs">
                <tr>
                    <th width="15%"><a href="sort">Дата</a></th>
                    <th width="65%" class="th-document-name"><a href="sort">Название документа<img src="img/ico-sort-down.gif" alt="" /></a></th>
                    <th width="20%"><a href="sort">автор/получатель</a></th>
                </tr>
                @foreach (var aut in auth.OrderBy(au => au.GetDirect("http://fogid.net/o/adoc")?.GetStr("http://fogid.net/o/from-date")))
                {
                    var doc = aut.GetDirect("http://fogid.net/o/adoc");
                    if (doc == null) continue;
                    string dt = doc.GetDates();
                    string? nm = doc.GetText("http://fogid.net/o/name");
                    string? ds = doc.GetText("http://fogid.net/o/description");
                    var auth_spec = aut.SayStr("http://fogid.net/o/authority-specificator");
                    //string au_s = auth_spec == "author" ? "автор" :
                    //(auth_spec == "recipient" ? "получатель" : auth_spec);
                    <tr valign="top">
                        <td width="15%">@dt</td>
                        <td width="65%">
                            <a href='?id=@doc.Id'>@nm</a><br />
                            <span class="small">@ds</span>
                        </td>
                        <td width="20%">
                            @auth_spec
                        </td>
                    </tr>
                }
            </table>
        }
        @if (refl_docs.Count() > 0)
        {
            <br />
            <div class="heading3">
                <h3>Отражен в документах</h3>
            </div>

            <table cellpadding="0" cellspacing="0" border="0" width="100%" class="info-docs">
                <tr>
                    <th width="20%"><a href="sort">Дата</a></th>
                    <th width="80%" class="th-document-name"><a href="sort">Название документа<img src="img/ico-sort-down.gif" alt="" /></a></th>
                </tr>
                @foreach (var doc in refl_docs
    .Select(r => r.GetDirect("http://fogid.net/o/in-doc"))
    .Where(d => d != null)
    .OrderBy(r => r?.GetStr("http://fogid.net/o/from-date")))
                {
                    string dt = doc.GetDates();
                    string? nm = doc.GetText("http://fogid.net/o/name");
                    string? ds = doc.GetText("http://fogid.net/o/description");

                    <tr valign="top">
                        <td width="20%">@dt</td>
                        <td width="80%">
                            <a href='?id=@doc.Id'>@nm</a><br />
                            <span class="small">@ds</span>
                        </td>
                    </tr>
                }
            </table>
        }

    }
    else if (m.db.ontology.DescendantsAndSelf("http://fogid.net/o/document").Contains(tree.Tp))
    {
        string? id = m.id;

        // Части документа
        Rec? uppart = tree.GetInverse("http://fogid.net/o/partItem") // Набор разных частей цепочек к документам, обычно одна часть
            .FirstOrDefault(); // Выбираем одну произвольную
        Rec? updoc = uppart?.GetDirect("http://fogid.net/o/inDocument");
        RRecord? mrrec = updoc == null ? null : m.db.GetRRecord(updoc.Id, true);
        int part_ind = -1;
        RRecord[] upparts = new RRecord[0];
        if (mrrec != null)
        {
            // Найдем все части документа и отсортируем их по номерам страниц
            upparts = mrrec.Props
                .Where(r => r is RInverseLink && r.Prop == "http://fogid.net/o/inDocument")
                .Cast<RInverseLink>()
                .Select(ril =>
                    {
                        RRecord? rrec = m.db.GetRRecord(ril.Source, false);
                        string pg = rrec?.GetField("http://fogid.net/o/pageNumbers") ?? "";
                        RRecord? doc = rrec?.GetDirect("http://fogid.net/o/partItem");
                        return new { rrec, pg, doc };
                    })
                .OrderBy(triple => triple.pg)
                .ThenBy(triple => triple.doc?.GetName() ?? "")
                .Select(triple => triple.doc)
                .Where(d => d != null)
                .Cast<RRecord>()
                .ToArray();
            // Теперь найдем "свою" часть и ее индекс
            part_ind = upparts.Select((d, i) => new { d, i })
                .First(pa => pa.d.Id == id)
                .i;
        }

        string? uri = tree.GetStr("http://fogid.net/o/uri");
        string? doccontent =  tree.GetText("http://fogid.net/o/doc-content");

        // Отражения
        var reflections = tree.GetInverse("http://fogid.net/o/in-doc")
            .Select(re => re.GetDirect("http://fogid.net/o/relected"));

        // Авторы и получатели
        var authorities = tree.GetInverse("http://fogid.net/o/adoc")
            .Select(au => new
            {
                author = au.GetDirect("http://fogid.net/o/author"),
                spec = au.GetStr("http://fogid.net/o/authority-specificator")
            });
        // Дополнения от Фурсенко
        var authors = authorities.Where(pa => pa.spec == "author" || pa.spec == "out-org")
            .Select(pa => pa.author);
        var recipients = authorities.Where(pa => pa.spec == "recipient" || pa.spec == "in-org")
            .Select(pa => pa.author);
        // Геоинформация
        var geoplaces = tree.GetInverse("http://fogid.net/o/something")
            .Select(inv => inv.GetDirect("http://fogid.net/o/location-place"));
        // Источник поступления
        var infosource = tree.GetInverse("http://fogid.net/o/archive-item")
            .Select(am => am.GetDirect("http://fogid.net/o/info-source")).FirstOrDefault();

        // Элемент коллекций
        var collections = tree.GetInverse("http://fogid.net/o/collection-item")
            .Select(inv => inv.GetDirect("http://fogid.net/o/in-collection"));

        <p class="grad">
            <a href="" class="nov"><img src="img/ico-home.gif" class="ico-home" alt="" />Открытый архив</a>
            &raquo;
            Документы
            &raquo;

            @if (true)
            {
                var pth = OpenA.App_Code.CollectionPath.PathToBase(id, m.funds_id, m.db);
                if (pth != null)
                {
                    foreach (var cnode in pth.Take(pth.Count() - 1))
                    {
                        if (cnode == null) { continue; }
                        //collection_depth++;
                        string nm = cnode.GetName();
                        <a href='?id=@cnode.Id'>@nm</a>
                        <span>&raquo;</span>
                    }
                }
            }

            @name
        </p>
        <div class="heading1"> <h1>@name</h1> </div>
        @if (upparts != null && upparts.Length > 0)
        {
            <div>
                @if (part_ind != -1 && upparts != null)
                {
                    <a href="?id=@updoc?.Id">К документу</a>
                    <span> | </span>
                }
                @if (part_ind > 0)
                {
                    string? idd = upparts?[part_ind - 1].Id;   //.GetDirect("http://fogid.net/o/partItem")?.Id;
                    <a href="?id=@idd">пред.</a>
                }
                else
                {
                    <span>пред.</span>
                }
                <span> | </span>
                @if (part_ind < upparts?.Length - 1)
                {
                    string? idd = upparts?[part_ind + 1].Id; //.GetDirect("http://fogid.net/o/partItem")?.Id;
                    <a href="?id=@idd">след.</a>
                }
                else
                {
                    <span>след.</span>
                }
            </div>
        }


        @if (uri != null)
        {
            if (tree.Tp == "http://fogid.net/o/photo-doc")
            {
                <img src="photo?s=normal&u=@(uri)" />
            } 
            else if (tree.Tp == "http://fogid.net/o/video-doc")
            {
                <video src="video?u=@(uri)" controls="controls" autoplay="autoplay" />
            }
            else if (tree.Tp == "http://fogid.net/o/audio-doc")
            {
                <audio src="audio?u=@(uri)" />
            }
            else if (tree.Tp == "http://fogid.net/o/document")
            {
                <embed src="doc?u=@(uri)" width="1024" height="800" />
            }
        }
        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="info-document">
            @if (!string.IsNullOrEmpty(dates))
            {
                <tr valign="top">
                    <td width="25%" class="line-name">Дата:</td>
                    <td width="75%" class="line-info">@dates</td>
                </tr>
            }
            @if (!string.IsNullOrEmpty(description))
            {
                <tr valign="top">
                    <td width="25%" class="line-name">Описание документа:</td>
                    <td width="75%" class="line-info">@description</td>
                </tr>
            }
            @{
                // Части документа
                var parts = tree.GetInverse("http://fogid.net/o/inDocument")
                .Select(dp => new
                {
                    docpart = dp.GetDirect("http://fogid.net/o/partItem"),
                    page = dp.GetStr("http://fogid.net/o/pageNumbers")
                })
                .OrderBy(pair => pair.page)
                .ThenBy(pair => pair.docpart?.GetText("http://fogid.net/o/name"))
                .Select(pair => pair.docpart);

                @if (parts.Count() > 0)
                {
                    <tr>
                        <td class="doc-show-small">&nbsp;</td>
                        <td class="doc-show-small">
                            @foreach (var doc in parts)
                            {
                                if (doc == null) { continue; }
                                string? nm = doc?.GetText("http://fogid.net/o/name");
                                string? uri_doc = doc?.GetStr("http://fogid.net/o/uri");

                                string src = doc.Tp == "http://fogid.net/o/photo-doc" ? $"photo?u={uri_doc}&s=small" :
                                (doc.Tp == "http://fogid.net/o/video-doc" ? "img/video_m.jpg" :
                                (doc.Tp == "http://fogid.net/o/audio-doc" ? "img/audio_m.jpg" :
                                (doc.Tp == "http://fogid.net/o/document" && uri_doc != null ? "img/PDF_m.jpg" :
                                (doc.Tp == "http://fogid.net/o/document" && uri_doc == null ? "img/document_m.jpg" :
                                (doc.Tp == "http://fogid.net/o/collection" ? "img/collection_m.jpg" :
                                "img/error.jpg")))));

                                <div class="show-small">
                                    <a href="?id=@doc?.Id"><img src="@src" border="0" vspace="10" hspace="10" alt="" /></a>
                                    <br />
                                    @nm
                                </div>
                            }

                        </td>
                    </tr>
                }
            }
            @if (!string.IsNullOrEmpty(doccontent))
            {
                string[] lines = doccontent.Split('\n');
                <tr valign="top">
                    <td width="25%" class="line-name">Текст документа:</td>
                    <td width="75%" class="line-info">
                        @foreach (var line in lines)
                        {
                            <p>
                                @line
                            </p>
                        }
                    </td>
                </tr>
            }
            @if (reflections.Count() > 0)
            {
                string sep = "";
                <tr valign="top">
                    <td width="25%" class="line-name">Отраженные персонажи:</td>
                    <td width="75%" class="line-info">
                        @foreach (var who in reflections)
                        {
                            if (who == null) { continue; }
                            @sep
                            ; sep = ",";
                            <a href='?id=@(who.Id)'>@who.GetText("http://fogid.net/o/name")</a>
                            ;

                        }
                    </td>
                </tr>
            }
            @if (authors.Count() > 0)
            {
                string sep = "";
                <tr valign="top">
                    <td width="25%" class="line-name">Авторы документа:</td>
                    <td width="75%" class="line-info">

                        @foreach (var au in authors)
                        {
                            if (au == null) { continue; }
                            @sep
                            ; sep = ", ";  // Добавлен разделитель
                            <a href='?id=@au.Id'>@au.GetText("http://fogid.net/o/name")</a>
                            ;
                        }
                    </td>
                </tr>
            }
            @if (recipients.Count() > 0)
            {
                string sep = "";
                <tr valign="top">
                    <td width="25%" class="line-name">Адресаты документа:</td>
                    <td width="75%" class="line-info">
                        @foreach (var au in recipients)
                        {
                            if (au == null) { continue; }
                            @sep
                            ; sep = ",";  // Добавлен разделитель
                            <a href='?id=@au.Id'>@au.GetText("http://fogid.net/o/name")</a>
                            ;
                        }
                    </td>
                </tr>
            }
            @if (geoplaces.Count() > 0)
            {
                <tr valign="top">
                    <td width="25%" class="line-name">Геоинформация:</td>
                    <td width="75%" class="line-info">
                        @foreach (var geo in geoplaces)
                        {
                            if (geo == null) { continue; }
                            <a href='?id=@geo.Id'>@geo.GetText("http://fogid.net/o/name")</a>
                        }
                    </td>
                </tr>
            }
            @if (infosource != null)
            {
                <tr valign="top">
                    <td width="25%" class="line-name">Источник поступления:</td>
                    <td width="75%" class="line-info">
                        <a href='?id=@infosource.Id'>@infosource.GetText("http://fogid.net/o/name")</a>
                        @*                         @if (descr_infosource != null)
                        {
                            <span>@descr_infosource.Value</span>
                        } *@
                    </td>
                </tr>
            }
            @if (collections.Count() > 0)
            {
                <tr valign="top">
                    <td width="25%" class="line-name">Документ входит в коллекции:</td>
                    <td width="75%" class="line-info">
                        @foreach (var coll in collections)
                        {
                            if (coll == null) { continue; }
                            <a href='?id=@coll.Id'>@coll.GetText("http://fogid.net/o/name")</a>
                            <br />
                        }
                    </td>
                </tr>
            }

        </table>
    }
    else if (tree.Tp == "http://fogid.net/o/collection" && m.id == m.funds_id) // =========== Начальная страница (Фонды)
    {
        var colldocs = tree.GetInverse("http://fogid.net/o/in-collection")
            .Select(dp => new
            {
                ele = dp.GetDirect("http://fogid.net/o/collection-item"),
                page = dp.GetStr("http://fogid.net/o/pageNumbers")
            })
            .OrderBy(pair => pair.page)
            .ThenBy(pair => pair.ele?.GetText("http://fogid.net/o/name"))
            .Select(pair => pair.ele)
            .Where(r => r != null)
            .Cast<Rec>();

        <p class="grad">
            <a href="Default.cshtml" class="nov"><img src="img/ico-home.gif" class="ico-home" alt="" />Открытый архив</a>
            &raquo;
            Фонды
        </p>

        <div class="heading1">
            <h1>@(tree.GetText("http://fogid.net/o/name"))</h1>
        </div>
        @foreach (Rec r in colldocs)
        {
            string? nme = r.GetText("http://fogid.net/o/name");
            string img_src = "img/fund89x89.jpg";
            RRecord? rRecord = m.db.GetRRecord(r.Id, true);
            if (rRecord == null) { continue; }
            // Возьмем первую фотку, отражающую коллекцию (фонд)
            var foto = rRecord.Props.Where(p => p is RInverseLink && p.Prop == "http://fogid.net/o/reflected")
                .Cast<RInverseLink>()
                .Select(ri => m.db.GetRRecord(ri.Source, false)?
                    .GetDirect("http://fogid.net/o/in-doc"))
                    .FirstOrDefault(d => d != null && d.Tp == "http://fogid.net/o/photo-doc");

            if (foto != null)
            {
                string? uri = foto.GetField("http://fogid.net/o/uri"); 
                img_src = "photo?s=small&u=" + uri;
            }

            <div class="block-25 small">
                <a href="?id=@(r.Id)">
                    <img class="fund-face" style="background: url('@(img_src)') center no-repeat;background-size:contain;" />
                    <br />
                    <img src="img/line-person.gif" class="line-face" alt="" /><br />
                    <span>@(r.GetText("http://fogid.net/o/name"))</span>
                </a>
            </div>
        }
        <br clear="all" />


        @*         @RenderPage("PageParticipants.cshtml")
        @section rightpanel {
        @RenderPage("PageAboutSmall.cshtml")
        @RenderPage("PageUseLinks.cshtml")
 *@

    }
    else if (m.db.ontology.DescendantsAndSelf("http://fogid.net/o/collection").Contains(tree.Tp))
    {
        // Предвычисления
        string? id = m.id;

        // элементы коллекции
        Rec[] elements = tree.GetInverse("http://fogid.net/o/in-collection")
        .Select(dp => new
        {
            docpart = dp.GetDirect("http://fogid.net/o/collection-item"),
            page = dp.GetStr("http://fogid.net/o/pageNumbers")
        })
        .OrderBy(pair => pair.page)
        .ThenBy(pair => pair.docpart?.GetText("http://fogid.net/o/name"))
        .Select(pair => pair.docpart)
        .Where(d => d != null)
        .Cast<Rec>()
        .ToArray();

        var documents = elements.Where(el => m.db.ontology.DescendantsAndSelf("http://fogid.net/o/document").Contains(el.Tp));
        var subcollections = elements.Where(el => m.db.ontology.DescendantsAndSelf("http://fogid.net/o/collection").Contains(el.Tp));

        // Это пролог
        <p class="grad">
            <a href="" class="nov"><img src="img/ico-home.gif" class="ico-home" alt="" />Открытый архив</a>
            &raquo;
            Коллекции
            &raquo;
            @if (true)
            {
                var pth = OpenA.App_Code.CollectionPath.PathToBase(id, m.funds_id, m.db);
                if (pth != null)
                {
                    foreach (var cnode in pth.Take(pth.Count() - 1))
                    {
                        if (cnode == null) { continue; }
                        //collection_depth++;
                        string nm = cnode.GetName();
                        <a href='?id=@cnode.Id'>@nm</a>
                        <span>&raquo;</span>
                    }
                }
            }
            @name
        </p>
        <div class="heading1"> <h1>@name</h1> </div>
        <p>@description</p>


        <p class="page-short-info">Подколлеций: @subcollections.Count()  |  Документов: @documents.Count() </p>
        <br />

        @* =============== Коллекции =============== *@

        @if (subcollections.Count() > 0)
        {
            <ul class="coll-tree">
                @foreach (Rec ite in subcollections)
                {
                    string? ite_id = ite.Id;
                    var ite_name_el = ite.GetText("http://fogid.net/o/name");
                    string ite_name = ite_name_el == null ? "noname" : ite_name_el;
                    //if (collection_depth == 0 && ite_name.StartsWith("Исходные материалы")) { continue; }
                    <li><a href="?id=@ite_id">@ite_name</a></li>
                }
            </ul>
        }
        <br /> 

        @* =============== Документы =============== *@
        @if (documents.Count() > 0)
        {
            <div class="heading3">
                <h3>Коллекция содержит документы</h3>
            </div>

            <table cellpadding="0" cellspacing="0" border="0" width="100%" class="info-docs">
                <tr>
                    <th width="16%"><a href="sort">Дата</a></th>
                    <th width="60%" class="th-document-name"><a href="sort">Название документа<img src="img/ico-sort-down.gif" alt="" /></a></th>
                    <th width="25%"><a href="sort">Автор&nbsp;&nbsp;=>&nbsp;&nbsp;Адресат</a></th>
                </tr>
                @foreach (Rec ite in documents)
                {
                    var ite_name_el = ite.GetText("http://fogid.net/o/name");
                    string ite_name = ite_name_el == null ? "noname" : ite_name_el;
                    var fd_el = ite.GetStr("http://fogid.net/o/from-date");
                    string fd = fd_el == null ? "" : fd_el;
                    string? ite_id = ite.Id;
                    var d_el = ite.GetText("http://fogid.net/o/description");
                    string d = d_el == null ? "" : d_el;
                    if (d.Length > 78) { d = d.Substring(0, 78); }
                    RRecord? rRecord = m.db.GetRRecord(ite_id, true);
                    var au_receps = rRecord?.Props.Where(p => p is RInverseLink && p.Prop == "http://fogid.net/o/adoc")
                        .Cast<RInverseLink>()
                        .Select(ri => m.db.GetRRecord(ri.Source, false))
                        .Where(rr => rr != null)
                        .Cast<RRecord>()
                        .Select(rr => new { aurec = rr.GetDirect("http://fogid.net/o/author"), 
                            spec = rr.GetField("http://fogid.net/o/authority-specificator") })
                    .ToArray();
                    var authors = au_receps?
                        .Where(pa => pa.spec == "author" || pa.spec == "out-org")
                        .Select(pa => pa.aurec)
                        .Where(x => x != null)
                        .Cast<RRecord>()
                        .ToArray();

                    var recipients = au_receps?
                        .Where(pa => pa.spec == "recipient" || pa.spec == "in-org")
                        .Select(pa => pa.aurec)
                        .Where(x => x != null)
                        .Cast<RRecord>()
                        .ToArray();

                    <tr valign="top">
                        <td width="15%">@fd</td>
                        <td width="60%" class="norma">
                            <!--			<a href="Portrait.cshtml?id=@ite_id"><img src="img/icon-doc.png" class="icon-doc" alt="" />
                            @ite_name</a><br />  Убрал А. Фурсенко-->
                            <a href="?id=@ite_id">@ite_name</a><br />
                            <span class="small">@d</span>
                        </td>
                        <!--td width="25%"><a href="author">И.О. Фамилия</a>, <a href="author">Ф.И. Отчество</a></td -->
                        <!-- добавил class="norma" -->
                        <td width="25%" class="norma">
                            @if(authors != null && authors.Length > 0) {
                                string sep = "";
                                foreach (var au in authors)
                                {
                                    var nm_att = au.GetName();
                                    string nm = nm_att ?? "noname";
                                    string idd = au.Id ?? "noid";
                                    @sep
                                    ;
                                    sep = ",";
                                    <a href='?id=@idd'>@nm</a>
                                    ;
                                    //                   sep = ",";                        // разделитель
                                }
                                sep = "";
                                //                @sep;
                                <span>=></span>
                                @if (recipients != null && recipients.Length > 0)
                                foreach (var au in recipients)
                                {
                                    string? nm = au.GetName();

                                    @sep
                                    ;
                                    //                   <span>=></span> добавил class="icon-doc"
                                    sep = ",";
                                    <a href='?id=@au.Id'>@nm</a>
                                    ;
                                }
                            }
                        </td>
                    </tr>
                }
            </table>
        }

    }
    else
    {
        <div>Это запись типа @tree.Tp</div>
    }
}
