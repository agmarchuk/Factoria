@using FactographData;
@using FactographData.r;

@inject IFDataService db

<div>
    @foreach (var v in tree.Props)
    {
        if (v is Tex)
        {
            var txts = (Tex)v;
            string tx = txts.Values.Aggregate<TextLan>((t1, t2) =>
            {
                if (t1.Lang == "ru") return t1;
                if (t2.Lang == "ru") return t2;
                return t2;
            }).Text;
            <a href="">@(tx)</a>
        } 
        else if (v is Str)
        {
            string s = ((Str)v).Value;
            <span>&nbsp; @(s)</span>
        }
    }
</div>

@code {
        [Parameter]
        public string? entityId { get; set; }

    private RRecord? rRecord = null;
    private Rec? tree = null;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (entityId != null)
        {
            rRecord = db.GetRRecord(entityId, true);
        }
        string ty = "http://fogid.net/o/person";

        Rec shablon = GetUniShablon(ty, 2, null);
        tree = Rec.Build(rRecord, shablon, id => db.GetRRecord(id, true));
    }
    private Rec GetUniShablon(string ty, int level, string? forbidden)
    {
        // Все прямые возможнные свойства
        string[] dprops = db.ontology.GetDirectPropsByType(ty).ToArray();
        var propsdirect = dprops.Select<string, Pro?>(pid =>
            {
                var os = db.ontology.OntoSpec
                    .FirstOrDefault(o => o.Id == pid);
                if (os == null) return null;
                if (os.Tp == "DatatypeProperty")
                {
                    var tt = db.ontology.RangesOfProp(pid).FirstOrDefault();
                    bool istext = tt == "http://fogid.net/o/text" ? true : false;
                    if (istext) return new Tex(pid);
                    else return new Str(pid);
                }
                else if (os.Tp == "ObjectProperty" && level > 0 && os.Id != forbidden)
                {
                    var tt = db.ontology.RangesOfProp(pid).FirstOrDefault();
                    if (tt == null) return null;
                    return new Dir(pid, new Rec[] { GetUniShablon(tt, 0, null) }); // Укорачивает развертку шаблона
                }
                return null;
            }).ToArray();
        string[] iprops = level > 1 ? db.ontology.GetInversePropsByType(ty).ToArray() : new string[0];
        var propsinverse = iprops.Select<string, Pro?>(pid =>
            {
                var os = db.ontology.OntoSpec
                    .FirstOrDefault(o => o.Id == pid);
                if (os == null) return null;
                if (os.Tp == "ObjectProperty")
                {
                    string[] tps = db.ontology.DomainsOfProp(pid).ToArray();
                    if (tps.Length == 0) return null;
                    return new Inv(pid, tps.Select(t => GetUniShablon(t, level - 1, pid)).ToArray());
                }
                return null;
            }).ToArray();
        var shab = new Rec(null, ty,
            propsdirect
            .Concat(propsinverse)
            .Where(p => p != null)
            .Cast<Pro>()
            .ToArray());
        return shab;
    }
    
}
