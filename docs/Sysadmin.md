# Документация системному администратору

В функциях системного администратора (СА) управлять размещением ресурсов системы Фактограф (проект Factoria) для предоставления пользователям возможности доступа через интерфейсы. Архитектура системы описана в разделе [Architecture.md]. 

Управление исходными файловыми наборами сканов, документов по идее не требуется поскольку они не "теряются" а хранятся в системе, но у нас это иногда делается для подстраховки. Хотя довольно быстро две версии (немного) разойдутся и будут возникать вопросы...

Кассеты могут создавать пользователи, но в наших (недоделанных) условиях часто это делает сисадмин.  

Главное для СА - управление кассетами. Это означает размещение кассет на серверах, их учет и контроль, создание резервных копий. Пока этот процесс не автоматизирован. 

Другое главное - разместить, настроить и поддерживать Веб-приложения. Для размещения используются те же сервера, что и для кассет. Сервер может быть Windows и Linux. Второй вариант считается предпочтительным. Приложения, в основном написаны для среды Asp.net и могут быть установлены и там и там с общего репозитория, хотя есть некоторые особенности. Администратору полезно быть знакомым с языком программирования C# и основами .NET и ASP.NET. Настройка, в основном заключается в создании конфигурационного файла config.xml, помещаемого туда, куда надо. Для некоторых систем возможна или необходима настройка другими средствами, описываемыми в документации. Стараемся сделать попроще. 

Еще одна функция для СА - управление пользователями. Для интерфейсов, допускающих редактирование данных построена система защиты. Для редактирующих пользователей необходма авторизация. Она (пока) довольно примитивная: есть незашифрованый XML-файл, куда СА заносит или меняет login и password какого-то пользователя. Еще требуется добавить в некоторый файл (порождается автоматически, но требует действий СА). Ну и данная кассета должна иметь конфигурационный атрибут write="yes".

## Практикум для администратора

Большинство действий СА не привычны, так чтобы понять что и как желательно выполнить в полном объеме предписанные действия. Да еще и задать вопросы более опутному коллеге. 

### Подготовительные действия

Надо определиться с машиной, рекомендую Windows. Потом можно будет проще работать с Linux. На машине клонируется репозиторий http://github.com/agmarchuk/Factoria.git. Далее, нужно скачать с сайта Microsoft дистрибутив .NET, это установщик - файл с именем что-нибудь вроде dotnet-sdk-7.0.203-win-x64.exe. Лучше скачать версию 7, хотя и в 8-й версией работать можно. Далее нужно определиться с редактором, можно и Far, но я предпочитаю Microsoft Visual Studio Code. Он "расцвечивает" код, дает возможность создавать и просматривать документацию в .md, есть встроенная консоль (Terminal) и много другого. После установки dotnet SDK, хорошо бы попробовать dotnet для проектирования консольного приложения HelloWorld. Пошаговая инструкция есть на сайте MS. 

### Создадим кассету

Единственная, но важная программа сделана только под Windows, это CManager - менеджер кассет. В репозитории найдем проект CManager, в котором найдем в bin/ программу CManager.exe. Смело ее запускаем, если все в порядке - хорошо, если "ругается" или не запускается, придется обойтись без менеджера. 

Программа старая, функциональность убогая, но для начала - сгодится.

Шаг 1 - Создание кассеты. Выберем место на диске для кассет и других данных, естественно не в репозитории, напр. D:/Home/Factograph/cassettes/. Создадим там новый проект через File/Create, далее с выбором директории и зададим имя кассете, напр. DemoCass. 

Теперь "положим" (Drug&Drop) на правуую панель какую-нибудь фотку (поддерживаются разные форматы). Довольно быстро, появится маленький вариант фотки в просмотровой панели. Самое время посмотреть что же мы натворили. Кассета появилась в виде директории с предписанным названием в предписанном месте. Посмотрим структуру нашей кассеты. Она сосотоит из одного файла и трех директорий: для оригиналов сохраняемых файлов, уменьшенных копий (директория documents) и метаинформации. "Покопавшись" в директориях можно найти введенную копию и ее уменьшенные копии. Пока достаточно о струкутре кассет.

Продолжим добавлять документы (фото-видео-аудио тоже документы), можно целыми папками с их подпапками и файлами. Только смотрите, чтобы ненужное не попало. Рекомендую набрать документы небольшого социума, лучше - семья. Много не надо, это всего лишь пробная кассета. Теперь у Вас имеется выбор в какую папку положить тот или иной материал. Для этого, в левой панели дерева находим нужную папку, выделяем ее и используем правую для переноса файлов. Рекомендую добавить еще одну папку с документами разного формата: PDF, .docx, .txt, видео, можно и другие. ПРЕДУПРЕЖДЕНИЕ: звуковые файлы пока не загружать! Если кнопка меню Video "посинеет", то надо ее нажать. Выполнится попытка сделать Web-ориентированные копии уменьшенного размера. Почти в любой момент работы с кассетой, можно выйти из программы по команде Exit или даже по крестику. Сделаем это и войдем снова через запуск CManager.exe, далее Load, выбор кассеты для загрузки и загрузку. В последнем есть тонкость: надо выбирать не директорию с названием кассеты, а файл имя_кассеты.finfo, имеющиеся в корне каждой кассеты.

Прежде чем продолжить содержаетльную работу с кассетой, посмотрим что в кассете изображается и может быть посмотрено. Находим документ (напр. PDF)и выделяем его в левой панели (или дважды нажимаем, если он в правой). Если это фотка, то она изобразится. Если это другой вид, то будет запускаться оригинал (копия помещенного в кассету файла) теми средствами, которые у Вас привязаны к соответсвующим расширениям. Например, видео у меня запускается обычным Windows Media Player. 

Проведем еще один эксперимент: попробуем повторно поместить уже имеющийся файл в кассету 
. Нагляднее - фотку. Попытка положить фотку на панель где она уже есть, будет неуспешной, но туда где ее нет, будет успешной. На самом деле, фотография останется в единственном варианте папками. Тот же "трюк" с папками наверное не получится. Будьте внимательны при формировании кассеты! Уничтожение документов в кассете пока нежелательно. Дело в том, что документ прописан в метаинформации и может быть в дальнейшем быть использован во внешней базе данных, за всеми связями трудно уследить, поэтому предложена альтернатива: элемент не уничтожается, а открепляется. На условно ненужной фотки в правой панели через правую кнопку выполним команду открепления. Фотка "исчезнет", но ее можно найти в мусорной корзине. Потом посмотрим останется ли она в Web интерфесах.

Перед тем, как закончить работу с кассетой, сделаем еще важное дело - заведем пользователя, естественно себя, для того, чтобы иметь право редактировать бау данных. Для этого, перейдем по таб-вкладке Users в таблицу редактирования. Делается указание  пользователя, которому придаются права редактирования данных делается через его возможный login-код. Код может быть и достаточно коротким, лишь бы другие пользователи его не применяли. Например, указываю mag111, нажимаю "Новый RDF-документ", получаю запись в таблице. Для экспериментов, добавлю еще одного пользователя, напр. tester.
Код пользователя должен быть выполнен в нижнем регистре (маленькими) латинскими буквами, цифрами или подчерком. 

Имеет смысл загянуть в получившуюся кассету. Там в оригиналах появились 2 файла с расширением .fog (от слова фактограф). Это пользовательские базы данных. Они текстовые XML-файлы, содержащие пользователские фрагменты базы данных. Все редактирующие действия пользователя над общими в кассете данными (добавление персон, связь документов с персонами и т.д.) локализуются в этом его файле. При  необходимости (неопытность, невнимательность, злой умысел и т.д.), этот файл может быть уничтожен руками системного администратора. Кстати, такой опыт у нас имеется, но корректно сделать это довольно непросто.  

### Создадим Web-приложение

Для этого, скомпилируем и исполнем новое приложение SypBlazor, имеющееся в репозитории Factoria. Это не сложно. Через Вашу любимую консоль, зайдем в директорию проекта и сконфигурируем приложение. Для конфигурирования, скопируем файл wwwroot/config0.xml в wwwroot/config.xml и отредактирум его. В любимом редакторе надо указать пустую директорию для базы данных  создаваемой информационной сборки и набор строк загрузки кассет. 

Далее, в командной консоли, вернемся в директорию SypBlazor и запустим известные прошедшим стадию HelloWorld компиляцию и исполнение команд:
```
dotnet build
dotnet run 
```
Если все в порядке, после компиляции, Вы увидите большой набор предупреждений, это неважно, главное, чтобы ошибок было 0. После исполнения второй команды, должен запуститься локальный сервер (сервис) с возможностью работы по указанным портам. И запуск и порты будут указаны в выводе консольного приложения. Теперь надо подсоединиться к сервису любимым браузером, напр. в адресной строке Хрома набрать что нибудь вроде:
```
https://localhost:54460/
```
Должна повиться содержательная страница. В идеале, страница будет страницей приложения, но у новичков часто не хватает внимательности и они ошибаются в настройках. Типичные ошибки:
- нет конфигурационного файла или в нем есть  синтаксические ошибки
- нет указанной в connectionstring директории или она не пуста
- нет полномочий для клиента или сервиса по работе с кассетами или директорией базы данных.

Последняя ошибка проявляется уже при конечном размещении на сервере для интернетного использования. Исправив допущенные ошибки в конфигурировании, добиваемся появления красивой картинки на экране. Отмечу, что локальный сервис продолжает работать, это видно по незавершенному потоку вывода на консоль. Сервис останавливается через стандарное нажатие <Cntl>C. Также нужно очищать директорию. указанную в  connectionstring. 

Все не так страшно, как можно было бы подумать, с опытом это будет делаться быстро. 